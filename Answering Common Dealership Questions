-- Create a primary marketing area based using the zip codes that the top 75% of sales originated from.

SELECT zip, count(*) AS units_sold,
		CASE
			WHEN SUM(COUNT(*)) OVER (ORDER BY COUNT(*) DESC)  
				< 
				(SELECT (COUNT(*)*.75)
				FROM dealership_sales)
			THEN 'TRUE'
			ELSE 'FALSE'
			END AS in_pma
FROM dealership_sales
LEFT JOIN customer_data
ON dealership_sales.driver_id = customer_data.driver_id
WHERE zip IS NOT NULL
GROUP BY zip
ORDER BY COUNT(*) DESC;

-- Calculate the dealership average for days on lot. What makes sell quicker on average and by how many days?

SELECT 
	make, 
	ROUND(AVG(CAST(days_on_lot AS FLOAT)), 2) AS avg_days_on_lot,
CASE 
	WHEN ROUND(AVG(CAST(days_on_lot AS FLOAT)), 2)
		<
		(SELECT ROUND(AVG(CAST(days_on_lot AS FLOAT)), 2) FROM dealership_sales) 
	THEN ((ROUND(AVG(CAST(days_on_lot AS FLOAT)), 2) - 
		(SELECT ROUND(AVG(CAST(days_on_lot AS FLOAT)), 2) FROM dealership_sales))
		*
		-1)
	END AS days_below_average
FROM dealership_sales
GROUP BY make
HAVING ROUND(AVG(CAST(days_on_lot AS FLOAT)), 2)
		< 
		(SELECT ROUND(AVG(CAST(days_on_lot AS FLOAT)), 2) FROM dealership_sales) 
ORDER BY days_below_average DESC;

--For each month display the total amount of sales on for that month. Display the amount changed from the previous month.

SELECT
 MONTH(deal_date) AS month_of_the_year,
 COUNT(MONTH(deal_date)) as deals_made,
	COUNT(MONTH(deal_date)) 
	- 
	LAG(COUNT(MONTH(deal_date))) OVER(ORDER BY MONTH(deal_date)) AS sales_count_change
FROM dealership_sales
GROUP BY MONTH(deal_date);

-- What zip codes have the highest average sell price? How much revenue was brought in from these zip codes? (Minimum 5 vehicles sold)

SELECT 
	zip, COUNT(*) AS vehicles_sold,
	AVG(sell_price) AS average_sell_price, 
	SUM(sell_price) AS total_revenue
FROM dealership_sales
JOIN customer_data
	ON dealership_sales.driver_id = customer_data.driver_id
GROUP BY zip
HAVING COUNT(*) > 5
ORDER BY AVG(sell_price) DESC; 

-- What are the 10 worst days of the month for sales?

SELECT TOP 10 
	DAY(deal_date) AS day_of_month, 
	COUNT(*) AS number_of_sales
FROM dealership_sales
GROUP BY DAY(deal_date)
ORDER BY COUNT(*) ASC;

-- Which offbrands did we sell the most of?

SELECT 
	make, 
	count(*) as number_of_sales
FROM dealership_sales
WHERE make != 'Ford'
GROUP BY make
ORDER BY count(*) DESC;

-- What is the top vehicle type by zip code. Prioritize the zip codes with the most sales.

SELECT 
	zip, 
	MAX(vehicle_type) AS most_common_type
FROM customer_data
JOIN dealership_sales
ON customer_data.driver_id = dealership_sales.driver_id
WHERE zip IS NOT NULL
GROUP BY zip
ORDER BY COUNT(*);


 --Willis Ford Houston wants to get testimonies from satisfied families. Pull contact information for households that have 2 or more different customers living there.

 SELECT address, zip, city, state
 FROM customer_data
 GROUP BY address, zip, city, state
 HAVING COUNT (*) > 1;
